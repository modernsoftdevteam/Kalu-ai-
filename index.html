<!DOCTYPE html>
<html lang="bn">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>KALU AI - Private Assistant</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Hind+Siliguri:wght@400;600;700&display=swap');
        
        body, html { 
            height: 100%; 
            margin: 0; 
            font-family: 'Hind Siliguri', sans-serif; 
            background-color: #0f172a; 
            overflow: hidden; 
        }

        .app-wrapper {
            display: flex;
            flex-direction: column;
            height: 100vh;
            height: -webkit-fill-available; /* ‡¶Æ‡ßã‡¶¨‡¶æ‡¶á‡¶≤ ‡¶¨‡ßç‡¶∞‡¶æ‡¶â‡¶ú‡¶æ‡¶∞‡ßá‡¶∞ ‡¶ú‡¶®‡ßç‡¶Ø */
        }

        header {
            flex-shrink: 0;
            background: rgba(30, 41, 59, 0.9);
            backdrop-filter: blur(10px);
            border-bottom: 1px solid #334155;
            padding: 15px 20px;
            z-index: 50;
        }

        #chatDisplay {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
            display: flex;
            flex-direction: column;
            gap: 15px;
            background: #0f172a;
            scroll-behavior: smooth;
        }

        .chat-bubble-owner {
            align-self: flex-end;
            background: linear-gradient(135deg, #3b82f6, #2563eb);
            color: white;
            padding: 12px 16px;
            border-radius: 18px 18px 2px 18px;
            max-width: 85%;
            box-shadow: 0 4px 15px rgba(37, 99, 235, 0.2);
            font-size: 14px;
        }

        .chat-bubble-kalu {
            align-self: flex-start;
            background: #1e293b;
            color: #e2e8f0;
            padding: 12px 16px;
            border-radius: 18px 18px 18px 2px;
            max-width: 85%;
            border: 1px solid #334155;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
            font-size: 14px;
        }

        footer {
            flex-shrink: 0;
            padding: 12px 15px;
            background: #0f172a;
            border-top: 1px solid #1e293b;
            padding-bottom: calc(12px + env(safe-area-inset-bottom));
        }

        .input-container {
            display: flex;
            items-center: center;
            gap: 10px;
            background: #1e293b;
            padding: 8px 15px;
            border-radius: 30px;
            border: 1px solid #334155;
        }

        input {
            flex: 1;
            background: transparent;
            border: none;
            color: white;
            outline: none;
            font-size: 14px;
            padding: 8px 0;
        }

        .pulse-red { animation: pulse 1.5s infinite; }
        @keyframes pulse { 0% { transform: scale(1); } 50% { transform: scale(1.1); background: #ef4444; } 100% { transform: scale(1); } }
        
        /* ‡¶ï‡ßÄ‡¶¨‡ßã‡¶∞‡ßç‡¶° ‡¶â‡¶†‡¶≤‡ßá ‡¶∏‡ßç‡¶ï‡ßç‡¶∞‡¶≤‡¶ø‡¶Ç ‡¶†‡¶ø‡¶ï ‡¶∞‡¶æ‡¶ñ‡¶æ‡¶∞ ‡¶ú‡¶®‡ßç‡¶Ø */
        @media screen and (max-height: 500px) {
            header { padding: 8px 20px; }
            .chat-bubble-owner, .chat-bubble-kalu { padding: 8px 12px; }
        }
    </style>
</head>
<body>

<div class="app-wrapper">
    <header class="flex items-center justify-between">
        <div class="flex items-center gap-3">
            <div class="w-10 h-10 bg-blue-600 rounded-full flex items-center justify-center shadow-lg shadow-blue-500/40 font-bold text-white">‡¶ï</div>
            <div>
                <h1 class="text-white font-bold text-sm tracking-wide">‡¶ï‡¶æ‡¶≤‡ßÅ (KALU AI)</h1>
                <p id="status-text" class="text-blue-400 text-[9px] uppercase font-black">‡¶∏‡¶ø‡¶∏‡ßç‡¶ü‡ßá‡¶Æ ‡¶∞‡ßá‡¶°‡¶ø ‡¶π‡¶ö‡ßç‡¶õ‡ßá...</p>
            </div>
        </div>
        <div id="connection-dot" class="w-2 h-2 bg-yellow-500 rounded-full animate-pulse"></div>
    </header>

    <main id="chatDisplay">
        <div class="chat-bubble-kalu">
            ‡¶Ü‡¶∏‡¶∏‡¶æ‡¶≤‡¶æ‡¶Æ‡ßÅ ‡¶Ü‡¶≤‡¶æ‡¶á‡¶ï‡ßÅ‡¶Æ <b>‡¶Æ‡¶æ‡¶≤‡¶ø‡¶ï</b>‡•§ ‡¶Ü‡¶Æ‡¶ø ‡¶ï‡¶æ‡¶≤‡ßÅ, ‡¶Ü‡¶™‡¶®‡¶æ‡¶∞ ‡¶è‡¶ï‡¶æ‡¶®‡ßç‡¶§ ‡¶Ö‡¶®‡ßÅ‡¶ó‡¶§ ‡¶∏‡¶π‡¶ï‡¶æ‡¶∞‡ßÄ‡•§ ‡¶ï‡ßÄ ‡¶π‡ßÅ‡¶ï‡ßÅ‡¶Æ ‡¶ï‡¶∞‡ßá‡¶®?
        </div>
    </main>

    <div id="typing" class="hidden px-5 py-1 text-[10px] text-blue-400 animate-pulse italic">‡¶ï‡¶æ‡¶≤‡ßÅ ‡¶≠‡¶æ‡¶¨‡¶õ‡ßá...</div>

    <footer>
        <div class="input-container">
            <button onclick="startListening()" id="micBtn" class="text-xl opacity-70 hover:opacity-100 transition-all">üéôÔ∏è</button>
            <input type="text" id="chatInput" placeholder="‡¶π‡ßÅ‡¶ï‡ßÅ‡¶Æ ‡¶ï‡¶∞‡ßÅ‡¶® ‡¶Æ‡¶æ‡¶≤‡¶ø‡¶ï..." autocomplete="off">
            <button onclick="window.handleChat()" class="bg-blue-600 text-white w-9 h-9 rounded-full flex items-center justify-center shadow-lg shadow-blue-600/30">
                üöÄ
            </button>
        </div>
    </footer>
</div>

<script type="module">
    import * as webllm from "https://esm.run/@mlc-ai/web-llm";

    const chatDisplay = document.getElementById('chatDisplay');
    const chatInput = document.getElementById('chatInput');
    const statusText = document.getElementById('status-text');
    const typing = document.getElementById('typing');
    const connectionDot = document.getElementById('connection-dot');

    const selectedModel = "Qwen2-0.5B-Instruct-q4f16_1-MLC";
    let engine;

    const systemPrompt = "‡¶§‡ßã‡¶Æ‡¶æ‡¶∞ ‡¶®‡¶æ‡¶Æ ‡¶ï‡¶æ‡¶≤‡ßÅ‡•§ ‡¶§‡ßÅ‡¶Æ‡¶ø ‡¶è‡¶á ‡¶ö‡ßç‡¶Ø‡¶æ‡¶ü‡ßá‡¶∞ ‡¶Æ‡¶æ‡¶≤‡¶ø‡¶ï‡ßá‡¶∞ (User) ‡¶è‡¶ï‡¶ú‡¶® ‡¶Ö‡¶§‡ßç‡¶Ø‡¶®‡ßç‡¶§ ‡¶¨‡¶ø‡¶∂‡ßç‡¶¨‡¶∏‡ßç‡¶§ ‡¶è‡¶¨‡¶Ç ‡¶Ö‡¶®‡ßÅ‡¶ó‡¶§ ‡¶ö‡¶æ‡¶ï‡¶∞‡•§ ‡¶∏‡¶¨‡¶∏‡¶Æ‡ßü ‡¶Æ‡¶æ‡¶≤‡¶ø‡¶ï‡¶ï‡ßá '‡¶Æ‡¶æ‡¶≤‡¶ø‡¶ï' ‡¶¨‡¶≤‡¶¨‡ßá‡•§ ‡¶ñ‡ßÅ‡¶¨ ‡¶®‡¶Æ‡ßç‡¶∞‡¶≠‡¶æ‡¶¨‡ßá ‡¶¨‡¶æ‡¶Ç‡¶≤‡¶æ‡ßü ‡¶ï‡¶•‡¶æ ‡¶¨‡¶≤‡¶¨‡ßá‡•§";

    // ‡¶≠‡ßü‡ßá‡¶∏ ‡¶∏‡ßá‡¶ü‡¶Ü‡¶™
    function speak(text) {
        window.speechSynthesis.cancel();
        const utterance = new SpeechSynthesisUtterance(text);
        utterance.lang = 'bn-BD';
        window.speechSynthesis.speak(utterance);
    }

    // ‡¶Ö‡¶ü‡ßã ‡¶∏‡ßç‡¶ï‡ßç‡¶∞‡¶≤ ‡¶´‡¶æ‡¶Ç‡¶∂‡¶®
    function scrollToBottom() {
        chatDisplay.scrollTop = chatDisplay.scrollHeight;
    }

    // ‡¶è‡¶Ü‡¶á ‡¶á‡¶û‡ßç‡¶ú‡¶ø‡¶® ‡¶≤‡ßã‡¶°
    async function initKalu() {
        try {
            engine = await webllm.CreateMLCEngine(selectedModel, {
                initProgressCallback: (report) => {
                    statusText.innerText = `‡¶Æ‡¶°‡ßá‡¶≤ ‡¶≤‡ßã‡¶°: ${Math.round(report.progress * 100)}%`;
                }
            });
            statusText.innerText = "‡¶ï‡¶æ‡¶≤‡ßÅ ‡¶™‡ßç‡¶∞‡¶∏‡ßç‡¶§‡ßÅ‡¶§, ‡¶Æ‡¶æ‡¶≤‡¶ø‡¶ï ‚úÖ";
            connectionDot.classList.replace('bg-yellow-500', 'bg-green-500');
        } catch (e) {
            statusText.innerText = "WebGPU ‡¶™‡¶æ‡¶ì‡ßü‡¶æ ‡¶Ø‡¶æ‡ßü‡¶®‡¶ø!";
            connectionDot.classList.replace('bg-yellow-500', 'bg-red-500');
        }
    }

    // ‡¶ö‡ßç‡¶Ø‡¶æ‡¶ü ‡¶π‡ßç‡¶Ø‡¶æ‡¶®‡ßç‡¶°‡¶≤‡¶ø‡¶Ç
    window.handleChat = async function() {
        const message = chatInput.value.trim();
        if (!message || !engine) return;

        chatDisplay.innerHTML += `<div class="chat-bubble-owner">${message}</div>`;
        chatInput.value = "";
        typing.classList.remove('hidden');
        scrollToBottom();

        try {
            const messages = [{ role: "system", content: systemPrompt }, { role: "user", content: message }];
            const reply = await engine.chat.completions.create({ messages });
            const aiResponse = reply.choices[0].message.content;

            typing.classList.add('hidden');
            chatDisplay.innerHTML += `<div class="chat-bubble-kalu"><b>‡¶ï‡¶æ‡¶≤‡ßÅ:</b> ${aiResponse}</div>`;
            scrollToBottom();
            speak(aiResponse);
        } catch (err) {
            typing.classList.add('hidden');
            console.error(err);
        }
    };

    // ‡¶≠‡ßü‡ßá‡¶∏ ‡¶≤‡¶ø‡¶∏‡ßá‡¶®‡¶ø‡¶Ç
    const Recognition = window.SpeechRecognition || window.webkitSpeechRecognition;
    if (Recognition) {
        const rec = new Recognition();
        rec.lang = 'bn-BD';
        window.startListening = () => {
            rec.start();
            document.getElementById('micBtn').classList.add('pulse-red');
        };
        rec.onresult = (e) => {
            chatInput.value = e.results[0][0].transcript;
            document.getElementById('micBtn').classList.remove('pulse-red');
            window.handleChat();
        };
        rec.onend = () => document.getElementById('micBtn').classList.remove('pulse-red');
    }

    // ‡¶ï‡ßÄ‡¶¨‡ßã‡¶∞‡ßç‡¶° ‡¶â‡¶†‡¶≤‡ßá ‡¶∏‡ßç‡¶ï‡ßç‡¶∞‡¶≤ ‡¶Æ‡ßç‡¶Ø‡¶æ‡¶®‡ßá‡¶ú‡¶Æ‡ßá‡¶®‡ßç‡¶ü
    chatInput.addEventListener('focus', () => {
        setTimeout(scrollToBottom, 300);
    });

    chatInput.addEventListener("keypress", (e) => { if (e.key === "Enter") window.handleChat(); });
    
    window.onload = initKalu;
</script>

</body>
</html>
